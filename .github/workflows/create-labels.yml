name: Create Required Labels and Milestones

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Allow manual trigger

jobs:
  create-labels-and-milestones:
    runs-on: ubuntu-latest
    steps:
      - name: Create required labels
        uses: actions/github-script@v7
        with:
          script: |
            const repo = context.repo;
            const labels = [
              // Category labels
              { name: 'bug', color: 'd73a4a', description: 'Something isn\'t working' },
              { name: 'enhancement', color: 'a2eeef', description: 'New feature or request' },
              { name: 'epic', color: '0056ff', description: 'Large feature requiring multiple sub-tasks' },
              { name: 'maintenance', color: 'fef2c0', description: 'Maintenance and housekeeping tasks' },
              // Priority labels
              { name: 'priority-critical', color: 'b60205', description: 'Critical priority issue' },
              { name: 'priority-high', color: 'ff9f1c', description: 'High priority issue' },
              { name: 'priority-medium', color: 'ffdd57', description: 'Medium priority issue' },
              { name: 'priority-low', color: 'c2e0c6', description: 'Low priority issue' },
              // Status labels
              { name: 'needs-triage', color: 'd4c5f9', description: 'Needs to be reviewed by maintainers' },
              { name: 'needs-review', color: 'bfe5bf', description: 'Awaiting review from maintainers' },
              { name: 'first-time-contributor', color: '1d76db', description: 'Issue created by first-time contributor' }
            ];

            for (const label of labels) {
              try {
                // Check if label exists
                await github.rest.issues.getLabel({
                  ...repo,
                  name: label.name
                });
                console.log(`Label ${label.name} already exists`);
              } catch (error) {
                if (error.status === 404) {
                  // Create label if it doesn't exist
                  await github.rest.issues.createLabel({
                    ...repo,
                    name: label.name,
                    color: label.color,
                    description: label.description
                  });
                  console.log(`Created label ${label.name}`);
                } else {
                  console.error(`Failed to check/create label ${label.name}:`, error);
                }
              }
            }

      - name: Create v1.0.0 milestone
        uses: actions/github-script@v7
        with:
          script: |
            const repo = context.repo;
            const milestone = {
              title: 'v1.0.0',
              description: 'First major release',
              state: 'open'
            };

            try {
              // Check if milestone exists
              const response = await github.rest.issues.listMilestones({
                ...repo,
                state: 'open',
                per_page: 100
              });
              const exists = response.data.some(m => m.title === milestone.title);
              if (exists) {
                console.log(`Milestone ${milestone.title} already exists`);
              } else {
                // Create milestone
                await github.rest.issues.createMilestone({
                  ...repo,
                  ...milestone
                });
                console.log(`Created milestone ${milestone.title}`);
              }
            } catch (error) {
              console.error(`Failed to check/create milestone ${milestone.title}:`, error);
            }
